(function(g){var a=g.History||{},h=g.history;if(typeof a.emulated!=="undefined")throw Error("History.js has already been emulated...");a.init=function(){a.emulated={pushState:!Boolean(g.history&&g.history.pushState&&g.history.replaceState),hashChange:Boolean(!("onhashchange"in g||"onhashchange"in document)||a.Adapter.getBrowserFlag()==="msie"&&a.Adapter.getBrowserMajorVersion()<8)};a.debug=function(){a.debug.enable&&a.log.apply(a,arguments)};a.debug.enable=true;a.log=function(){if(typeof console===
"undefined"){for(var b=arguments[0],c=1,d=arguments.length;c<d;++c)b+="\n\n"+arguments[c];alert(b)}else console.log.apply(console,[arguments])};a.setHash=function(b){a.debug("History.setHash",this,arguments,b);document.location.hash=a.normalizeHash(b);return b};a.getHash=function(){return a.normalizeHash(document.location.hash)};a.normalizeHash=function(b){return b.replace(/[^#]*#/,"").replace(/#.*/,"")};a.extractHashFromUrl=function(b){return String(b).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2")};a.expandUrl=
function(b){b=b.replace(/#.*/,"");if(!/[a-z]+\:\/\//.test(b))if(b.length===0||b.substring(0,1)==="?")b=document.location.href.replace(/[#\?].*/,"")+b;else{var c=document.getElementsByTagName("base"),d=null;d="";if(c.length===1){d=c[0];d=d.href;if(d[d.length-1]!=="/")d+="/";b=d+b.replace(/^\//,"")}else if(b.substring(0,1)==="."){c=document.location.href.replace(/[#\?].*/,"").replace(/[^\/]+$/,"");if(c[c.length-1]!=="/")c+="/";b=c+b}else{c=document.location.protocol+"//"+(document.location.hostname||
document.location.host);if(document.location.port)c+=":"+document.location.port;c+="/";b=c+b.replace(/^\//,"")}}return b};a.getStateObject=function(b,c,d){return{data:b,title:c,url:d}};a.getStateHash=function(b,c,d){return JSON.stringify(a.getStateObject(b,c,d))};a.currentState=a.getStateObject({},document.title,document.location.href);a.getState=function(){return a.currentState};a.pushStateAndTrigger=function(b,c,d){a.pushState(b,c,d);a.Adapter.trigger(g,"popstate",{state:b});return true};a.replaceStateAndTrigger=
function(b,c,d){a.replaceState(b,c,d);a.Adapter.trigger(g,"popstate",{state:b});return true};a.debug("browser version:",a.Adapter.getBrowserMajorVersion());a.debug("browser flag:",a.Adapter.getBrowserFlag());a.debug("emulate hashchange:",a.emulated.hashChange);a.emulated.hashChange&&function(){var b=null;if(a.Adapter.getBrowserFlag()==="msie"){var c=document.createElement("iframe");c.setAttribute("id","historyjs-iframe");c.style.display="none";document.body.appendChild(c);c.contentWindow.document.open();
c.contentWindow.document.close();var d=null,f=null;b=function(){var e=a.getHash(),i=a.normalizeHash(c.contentWindow.document.location.hash);if(e!==d){d=e;a.debug("hashchange.checker: iframe hash check",i,e);if(i!==e){a.debug("hashchange.checker: iframe hash change",i,e);c.contentWindow.document.open();c.contentWindow.document.close();f=c.contentWindow.document.location.hash=e}a.Adapter.trigger(g,"hashchange")}else if(i!==f){a.debug("hashchange.checker: iframe hash out of sync",i,e);f=i;a.setHash(i)}return true}}else{d=
null;b=function(){var e=a.getHash();if(e!==d){d=e;a.Adapter.trigger(g,"hashchange")}return true}}setInterval(b,200);return true}();if(a.emulated.pushState){var j=function(b){a.debug("History.hashchange",this,arguments);var c=unescape(a.extractHashFromUrl(b&&b.newURL||document.location)),d=null;if(!c){a.debug("History.hashchange: state hash doesn't exist",c);return false}try{d=JSON.parse(c)}catch(f){a.debug("History.hashchange: JSON Parse Error",f);return false}var e=a.getState();e=a.getStateHash(e.data,
e.title,e.url);if(c===e){a.debug("History.hashchange: no change");return false}if(a.discardedState(d)){a.debug("History.hashchange: discarded");h.go(-1);return false}a.debug("History.hashchange: success hashchange");a.pushState(d.data,d.title,d.url);return true};a.Adapter.bind(g,"hashchange",j);a.discardedStates={};a.discardState=function(b,c,d){a.debug("History.discardState",this,arguments);var f=a.getStateHash(b,c,d);return a.discardedStates[f]=true};a.discardedState=function(b,c,d){b=a.getStateHash(b,
c,d);return typeof a.discardedStates[b]!=="undefined"};a.recycleState=function(b,c,d){a.debug("History.recycleState",this,arguments);a.discardedState(b,c,d)&&delete a.discardedStates[StateHash];return true};a.pushState=function(b,c,d){a.debug("History.pushState",this,arguments);d=a.expandUrl(d);b.url=d;b.title=c;a.recycleState(b,c,d);var f=a.getStateObject(b,c,d),e=a.getStateHash(b,c,d);e=escape(e);var i=a.getHash();if(f.title)document.title=f.title;a.currentState=f;a.Adapter.trigger(g,"popstate",
{state:f.data});if(i!==e&&escape(i)!==e){a.debug("History.pushState: update hash",e,i);a.setHash(e)}return true};a.replaceState=function(b,c){a.debug("History.replaceState",this,arguments);var d=a.getState();a.pushState(b,c,data);a.discardState(d.data,d.title,d.url);return true};if(!a.emulated.hashChange&&document.location.hash&&document.location.hash!=="#")a.Adapter.onDomLoad(function(){j()})}else{a.Adapter.bind(g,"popstate",function(b,c){a.debug("History.popstate",this,arguments);var d=a.expandUrl(document.location.href),
f=document.title,e={};if(b&&b.state)e=b.state;else if(b&&b.originalEvent&&b.originalEvent.state)e=b.originalEvent.state;else if(b&&b.memo&&b.memo.state)e=b.memo.state;else if(c&&c.state)e=c.state;f=e.title||f;d=a.getStateObject(e,f,d);if(d.title)document.title=d.title;a.currentState=d;return true});a.pushState=function(b,c,d){b.url=d;b.title=c;h.pushState.apply(h,[b,c,d])};a.replaceState=function(b,c,d){b.url=d;b.title=c;h.replaceState.apply(h,[b,c,d])};a.go=function(){h.go.apply(h,arguments)};a.back=
function(){h.back.apply(h,arguments)};a.forward=function(){h.forward.apply(h,arguments)}}};typeof a.Adapter!=="undefined"&&a.init();g.History=a})(window);
