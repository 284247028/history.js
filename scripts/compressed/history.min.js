/*
 Public Domain
 @author Benjamin Lupton <contact@balupton.com>
 @author James Padolsey <https://gist.github.com/527683>
 Public Domain
 @author Benjamin Lupton <contact@balupton.com>
*/
(function(i,m){i.History=i.History||{};var g=i.document,c={},b=i.History,j=i.history;if(typeof b.emulated!=="undefined")throw Error("History.js has already been emulated...");b.init=function(){b.debug=function(){b.debug.enable&&b.log.apply(b,arguments)};b.debug.enable=false;b.log=function(){if(typeof console==="undefined"){for(var a="\n"+arguments[0]+"\n",d=1,e=arguments.length;d<e;++d)a+="\n"+arguments[d]+"\n";if(d=g.getElementById("log"))d.value+=a+"\n-----\n";else alert(a)}else console.log.apply(console,
[arguments])};c.getInternetExplorerMajorVersion=function(){return c.getInternetExplorerMajorVersion.cached=typeof c.getInternetExplorerMajorVersion.cached!=="undefined"?c.getInternetExplorerMajorVersion.cached:function(){for(var a=3,d=g.createElement("div"),e=d.getElementsByTagName("i");d.innerHTML="<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>",e[0];);return a>4?a:void 0}()};c.isInternetExplorer=function(){return c.isInternetExplorer.cached=typeof c.isInternetExplorer.cached!=="undefined"?c.isInternetExplorer.cached:
c.getInternetExplorerMajorVersion()!==0};b.emulated={pushState:!Boolean(i.history&&i.history.pushState&&i.history.replaceState),hashChange:Boolean(!("onhashchange"in i||"onhashchange"in g)||c.isInternetExplorer()&&c.getInternetExplorerMajorVersion()<8)};b.setHash=function(a){var d=b.normalizeHash(a);b.debug("History.setHash",this,arguments,"hash:",a,"normalizedHash:",d);g.location.hash=d;return a};b.getHash=function(){return b.normalizeHash(g.location.hash)};b.normalizeHash=function(a){return a.replace(/[^#]*#/,
"").replace(/#.*/,"")};b.extractHashFromUrl=function(a){return String(a).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2")};b.isTraditionalAnchor=function(a){a=b.extractHashFromUrl(a);return typeof g.getElementById(a)!=="undefined"};b.expandUrl=function(a){if(!/[a-z]+\:\/\//.test(a))if(a.length===0||a.substring(0,1)==="?")a=g.location.href.replace(/[#\?].*/,"")+a;else{var d=g.getElementsByTagName("base"),e=null;e="";if(d.length===1){e=d[0];e=e.href;if(e[e.length-1]!=="/")e+="/";a=e+a.replace(/^\//,"")}else if(a.substring(0,
1)==="."){d=g.location.href.replace(/[#\?].*/,"").replace(/[^\/]+$/,"");if(d[d.length-1]!=="/")d+="/";a=d+a}else{d=g.location.protocol+"//"+(g.location.hostname||g.location.host);if(g.location.port)d+=":"+g.location.port;d+="/";a=d+a.replace(/^\//,"")}}return a};b.expandState=function(a){a=a||{};a={data:a.data||{},url:b.expandUrl(a.url||""),title:a.title||""};a.data.title=a.data.title||a.title;a.data.url=a.data.url||a.url;return a};b.createStateObject=function(a,d,e){a={data:a,title:d,url:e};return a=
b.expandState(a)};b.createStateHash=function(a){return JSON.stringify(a)};b.emulated.hashChange&&function(){c.checkerFunction=null;if(c.isInternetExplorer()){var a=g.createElement("iframe");a.setAttribute("id","historyjs-iframe");a.style.display="none";g.body.appendChild(a);a.contentWindow.document.open();a.contentWindow.document.close();var d=null,e=null;c.checkerFunction=function(){var f=b.getHash(),h=b.normalizeHash(a.contentWindow.document.location.hash);if(f!==d){d=f;b.debug("hashchange.checker: iframe hash check",
h,f);if(h!==f){b.debug("hashchange.checker: iframe hash change",h,f);a.contentWindow.document.open();a.contentWindow.document.close();e=a.contentWindow.document.location.hash=f}b.Adapter.trigger(i,"hashchange")}else if(h!==e){b.debug("hashchange.checker: iframe hash out of sync",h,f);e=h;b.setHash(h)}return true}}else{d=null;c.checkerFunction=function(){var f=b.getHash();if(f!==d){d=f;b.Adapter.trigger(i,"hashchange")}return true}}setInterval(c.checkerFunction,200);return true}();c.statesByUrl={};
c.duplicateStateUrls={};c.statesByHash={};c.savedStates=[b.createStateObject({},"",g.location.href)];b.getState=function(){return c.getStateByIndex()};b.getStateHash=function(){return b.createStateHash(b.getState())};c.getStateByUrl=function(a){return c.statesByUrl[a]||m};c.getStateByHash=function(a){return c.statesByHash[a]||m};c.storeState=function(a){var d=b.createStateHash(a),e=c.getStateByUrl(a.url);if(typeof e!=="undefined")if(b.createStateHash(e)!==d)c.duplicateStateUrls[a.url]=true;c.statesByUrl[a.url]=
c.statesByHash[d]=a;return true};c.saveState=function(a){c.savedStates.push(a);return true};c.getStateByIndex=function(a){var d=null;return d=typeof a==="undefined"?c.savedStates[c.savedStates.length-1]:a<0?c.savedStates[c.savedStates.length+a]:c.savedStates[a]};c.stateUrlExists=function(a){return typeof c.statesByUrl[a]!=="undefined"};c.urlDuplicateExists=function(a){return typeof c.duplicateStateUrls[a]!=="undefined"};c.savedHashes=[];c.saveHash=function(a){c.savedHashes.push(a);return true};c.getHashByIndex=
function(a){var d=null;return d=typeof a==="undefined"?c.savedHashes[c.savedHashes.length-1]:a<0?c.savedHashes[c.savedHashes.length+a]:c.savedHashes[a]};c.stateHashExists=function(a){return typeof c.statesByHash[a]!=="undefined"};if(b.emulated.pushState){c.onHashChange=function(a){b.debug("History.hashchange",this,arguments);var d=a&&a.newURL||g.location.href;currentHash=unescape(b.extractHashFromUrl(d));currentStateHashExits=currentStateHash=currentState=null;if(currentStateHash===c.getHashByIndex(-1)){b.log("History.hashchange: no change");
return false}c.saveHash(currentHash);try{currentState=JSON.parse(currentHash)}catch(e){currentState=b.createStateObject({},"",d)}currentStateHash=b.createStateHash(currentState);b.log("History.hashchange: ","currentStateHash",currentStateHash,"Hash -1",c.getHashByIndex(-1),"Hash -2",c.getHashByIndex(-2),"Hash -3",c.getHashByIndex(-3),"Hash -4",c.getHashByIndex(-4),"Hash -5",c.getHashByIndex(-5),"Hash -6",c.getHashByIndex(-6),"Hash -7",c.getHashByIndex(-7));if(d=c.discardedState(currentState)){b.log("forwardState:",
b.createStateHash(d.forwardState),"backState:",b.createStateHash(d.backState));if(c.getHashByIndex(-2)===b.createStateHash(d.forwardState)){b.log("History.hashchange: go backwards");b.back()}else{b.log("History.hashchange: go forwards");b.forward()}return false}b.debug("History.hashchange: success hashchange");b.pushState(currentState.data,currentState.title,currentState.url);return true};b.Adapter.bind(i,"hashchange",c.onHashChange);c.discardedStates={};c.discardState=function(a,d,e){b.debug("History.discardState",
this,arguments);var f=b.createStateHash(a);c.discardedStates[f]={discardedState:a,backState:e,forwardState:d};return true};c.discardedState=function(a){a=b.createStateHash(a);return c.discardedStates[a]||false};c.recycleState=function(a){b.debug("History.recycleState",this,arguments);var d=b.createStateHash(a);c.discardedState(a)&&delete c.discardedStates[d];return true};b.pushState=function(a,d,e){b.debug("History.pushState",this,arguments);var f=b.createStateObject(a,d,e),h=b.createStateHash(f);
b.getState();var k=b.getStateHash(),l=unescape(b.getHash());c.storeState(f);c.recycleState(f);if(f.title)g.title=f.title;b.log("History.pushState: details","newStateHash:",h,"oldStateHash:",k,"html4Hash:",l);h===k&&l===h&&b.log("History.pushState: no change");if(h!==l){b.log("History.pushState: update hash");b.setHash(escape(h));return false}c.saveState(f);b.log("History.pushState: trigger popstate");b.Adapter.trigger(i,"popstate",{state:f.data});return true};b.replaceState=function(a,d,e){b.log("History.replaceState",
this,arguments);var f=b.createStateObject(a,d,e),h=b.getState(),k=c.getStateByIndex(-2);c.discardState(h,f,k);b.pushState(f.data,f.title,f.url);return true};if(!g.location.hash||g.location.hash==="#")b.Adapter.onDomLoad(function(){b.log("hash1");var a=b.getState();b.pushState(a.data,a.title,a.url)});else if(!b.emulated.hashChange){b.log("hash2");b.Adapter.onDomLoad(function(){c.onHashChange()})}}else{c.onPopState=function(a,d){b.debug("_History.onPopState",this,arguments);var e={},f=null,h=null;f=
null;a=a||{};a.originalEvent=a.originalEvent||{};a.memo=a.memo||{};d=d||{};if(a.originalEvent.state===null)e=a.originalEvent.state;else if(typeof a.state!=="undefined")e=a.state;else if(typeof a.memo.state!=="undefined")e=a.memo.state;else if(typeof d.state!=="undefined")e=d.state;else if(typeof a.originalEvent.state!=="undefined"){f=b.expandUrl(g.location.href);e=c.getStateByUrl(f);f=c.urlDuplicateExists(f);e=typeof e!=="undefined"&&!f?e.data:a.originalEvent.state}e=typeof e!=="object"||e===null?
{}:e;f=e.title||"";h=e.url||g.location.href;f=b.createStateObject(e,f,h);c.storeState(f);c.saveState(f);if(f.title)g.title=f.title;return true};b.Adapter.bind(i,"popstate",c.onPopState);b.pushState=function(a,d,e){a=b.createStateObject(a,d,e);c.storeState(a);j.pushState(a.data,a.title,a.url);b.Adapter.trigger(i,"popstate",{state:a.data});return true};b.replaceState=function(a,d,e){a=b.createStateObject(a,d,e);c.storeState(a);j.replaceState(a.data,a.title,a.url);b.Adapter.trigger(i,"popstate",{state:a.data});
return true}}b.back=function(){return j.go(-1)};b.forward=function(){return j.go(1)}};typeof b.Adapter!=="undefined"&&b.init()})(window);
