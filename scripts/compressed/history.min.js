/*
 Public Domain
 @author Benjamin Lupton <contact@balupton.com>
 @author James Padolsey <https://gist.github.com/527683>
 Public Domain
 @author Benjamin Lupton <contact@balupton.com>
*/
(function(h,k){h.History=h.History||{};var g=h.document,c={},b=h.History,l=h.history;if(typeof b.emulated!=="undefined")throw Error("History.js has already been emulated...");b.init=function(){b.debug=function(){b.debug.enable&&b.log.apply(b,arguments)};b.debug.enable=false;b.log=function(){if(typeof console==="undefined"){for(var a="\n"+arguments[0]+"\n",d=1,e=arguments.length;d<e;++d)a+="\n"+arguments[d]+"\n";if(d=g.getElementById("log"))d.value+=a+"\n-----\n";else alert(a)}else console.log.apply(console,
[arguments])};c.getInternetExplorerMajorVersion=function(){return c.getInternetExplorerMajorVersion.cached=typeof c.getInternetExplorerMajorVersion.cached!=="undefined"?c.getInternetExplorerMajorVersion.cached:function(){for(var a=3,d=g.createElement("div"),e=d.getElementsByTagName("i");d.innerHTML="<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>",e[0];);return a>4?a:void 0}()};c.isInternetExplorer=function(){return c.isInternetExplorer.cached=typeof c.isInternetExplorer.cached!=="undefined"?c.isInternetExplorer.cached:
c.getInternetExplorerMajorVersion()!==0};b.emulated={pushState:!Boolean(h.history&&h.history.pushState&&h.history.replaceState),hashChange:Boolean(!("onhashchange"in h||"onhashchange"in g)||c.isInternetExplorer()&&c.getInternetExplorerMajorVersion()<8)};b.setHash=function(a){b.debug("History.setHash",this,arguments,a);g.location.hash=b.normalizeHash(a);return a};b.getHash=function(){return b.normalizeHash(g.location.hash)};b.normalizeHash=function(a){return a.replace(/[^#]*#/,"").replace(/#.*/,"")};
b.extractHashFromUrl=function(a){return String(a).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2")};b.isTraditionalAnchor=function(a){a=b.extractHashFromUrl(a);return typeof g.getElementById(a)!=="undefined"};b.expandUrl=function(a){if(!/[a-z]+\:\/\//.test(a))if(a.length===0||a.substring(0,1)==="?")a=g.location.href.replace(/[#\?].*/,"")+a;else{var d=g.getElementsByTagName("base"),e=null;e="";if(d.length===1){e=d[0];e=e.href;if(e[e.length-1]!=="/")e+="/";a=e+a.replace(/^\//,"")}else if(a.substring(0,1)==="."){d=
g.location.href.replace(/[#\?].*/,"").replace(/[^\/]+$/,"");if(d[d.length-1]!=="/")d+="/";a=d+a}else{d=g.location.protocol+"//"+(g.location.hostname||g.location.host);if(g.location.port)d+=":"+g.location.port;d+="/";a=d+a.replace(/^\//,"")}}return a};b.expandState=function(a){a=a||{};a={data:a.data||{},url:b.expandUrl(a.url||""),title:a.title||""};a.data.title=a.data.title||a.title;a.data.url=a.data.url||a.url;return a};b.createStateObject=function(a,d,e){a={data:a,title:d,url:e};return a=b.expandState(a)};
b.createStateHash=function(a,d,e){if(arguments.length===1){e=a.url||k;d=a.title||k;a=a.data}return JSON.stringify(b.createStateObject(a,d,e))};b.currentState=b.createStateObject({},"",g.location.href);b.getState=function(){return b.currentState};b.emulated.hashChange&&function(){c.checkerFunction=null;if(c.isInternetExplorer()){var a=g.createElement("iframe");a.setAttribute("id","historyjs-iframe");a.style.display="none";g.body.appendChild(a);a.contentWindow.document.open();a.contentWindow.document.close();
var d=null,e=null;c.checkerFunction=function(){var f=b.getHash(),i=b.normalizeHash(a.contentWindow.document.location.hash);if(f!==d){d=f;b.debug("hashchange.checker: iframe hash check",i,f);if(i!==f){b.debug("hashchange.checker: iframe hash change",i,f);a.contentWindow.document.open();a.contentWindow.document.close();e=a.contentWindow.document.location.hash=f}b.Adapter.trigger(h,"hashchange")}else if(i!==e){b.debug("hashchange.checker: iframe hash out of sync",i,f);e=i;b.setHash(i)}return true}}else{d=
null;c.checkerFunction=function(){var f=b.getHash();if(f!==d){d=f;b.Adapter.trigger(h,"hashchange")}return true}}setInterval(c.checkerFunction,200);return true}();c.statesByUrl={};c.duplicateStateUrls={};c.statesByHash={};c.storedStates=[];c.getStateByUrl=function(a){return c.statesByUrl[a]||k};c.getStateByHash=function(a){return c.statesByHash[a]||k};c.storeState=function(a){var d=b.createStateHash(a),e=c.getStateByUrl(a.url);if(typeof e!=="undefined")if(b.createStateHash(e)!==d)c.duplicateStateUrls[a.url]=
true;c.statesByUrl[a.url]=c.statesByHash[d]=a;c.storedStates.push(a);return true};c.getStateByIndex=function(a){if(typeof a==="undefined")c.storedStates(c.storedStates.length-1);else a<0?c.storedStates(c.storedStates-a):c.storedStates(a);return null};c.stateHashExists=function(a){return typeof c.statesByHash[a]!=="undefined"};c.stateUrlExists=function(a){return typeof c.statesByUrl[a]!=="undefined"};c.urlDuplicateExists=function(a){return typeof c.duplicateStateUrls[a]!=="undefined"};if(b.emulated.pushState){c.stateHashes=
[];c.onHashChange=function(a){b.debug("History.hashchange",this,arguments);var d=a&&a.newURL||g.location.href;currentHash=unescape(b.extractHashFromUrl(d));currentStateHashExits=currentStateHash=currentState=null;c.stateHashes.push(currentHash);try{currentState=JSON.parse(currentHash)}catch(e){currentState=b.createStateObject({},g.title,d)}currentStateHash=b.createStateHash(currentState);if(c.discardedState(currentState.data,currentState.title,currentState.url)){b.log("History.hashchange: discarded",
"currentStateHash",currentStateHash,"oldStateHash",oldStateHash,"-1",c.stateHashes[c.stateHashes.length-1],"-2",c.stateHashes[c.stateHashes.length-2],"-3",c.stateHashes[c.stateHashes.length-3],"-4",c.stateHashes[c.stateHashes.length-4]);if(c.stateHashes[c.stateHashes.length-3]===currentStateHash){b.log("History.hashchange: go backwards");b.back()}else{b.log("History.hashchange: go forwards");b.forward()}return false}c.storeState(currentState);b.debug("History.hashchange: success hashchange");b.pushState(currentState.data,
currentState.title,currentState.url);return true};b.Adapter.bind(h,"hashchange",c.onHashChange);c.discardedStates={};c.discardState=function(a,d,e){b.debug("History.discardState",this,arguments);var f=b.createStateHash(a,d,e);return c.discardedStates[f]=true};c.discardedState=function(a,d,e){a=b.createStateHash(a,d,e);return typeof c.discardedStates[a]!=="undefined"};c.recycleState=function(a,d,e){b.debug("History.recycleState",this,arguments);var f=b.createStateHash(a,d,e);c.discardedState(a,d,e)&&
delete c.discardedStates[f];return true};b.pushState=function(a,d,e){b.debug("History.pushState",this,arguments);var f=b.createStateObject(a,d,e),i=b.createStateHash(f.data,f.title,f.url),j=b.getState();j=b.createStateHash(j.data,j.title,j.url);var m=unescape(b.getHash());c.storeState(f);c.recycleState(f.data,f.title,f.url);if(f.title)g.title=f.title;b.debug("History.pushState: details","newStateHash:",i,"oldStateHash:",j,"html4Hash:",m);if(i===j&&m===i){b.log("History.pushState: no change");return false}b.currentState=
f;if(i!==m){b.debug("History.pushState: update hash");b.setHash(escape(i))}b.debug("History.pushState: trigger popstate");b.Adapter.trigger(h,"popstate",{state:f.data});return true};b.replaceState=function(a,d,e){b.log("History.replaceState",this,arguments);var f=b.getState();c.discardState(f.data,f.title,f.url);b.pushState(a,d,e);return true};if(!g.location.hash||g.location.hash==="#")b.Adapter.onDomLoad(function(){b.log("hash1");var a=b.getState();b.pushState(a.data,a.title,a.url)});else if(!b.emulated.hashChange){b.log("hash2");
b.Adapter.onDomLoad(function(){c.onHashChange()})}}else{c.onPopState=function(a,d){b.debug("_History.onPopState",this,arguments);var e={},f=null,i=null;f=null;a=a||{};a.originalEvent=a.originalEvent||{};a.memo=a.memo||{};d=d||{};if(a.originalEvent.state===null)e=a.originalEvent.state;else if(typeof a.state!=="undefined")e=a.state;else if(typeof a.memo.state!=="undefined")e=a.memo.state;else if(typeof d.state!=="undefined")e=d.state;else if(typeof a.originalEvent.state!=="undefined"){f=b.expandUrl(g.location.href);
e=c.getStateByUrl(f);f=c.urlDuplicateExists(f);e=typeof e!=="undefined"&&!f?e.data:a.originalEvent.state}e=typeof e!=="object"||e===null?{}:e;f=e.title||"";i=e.url||g.location.href;f=b.createStateObject(e,f,i);c.storeState(f);if(f.title)g.title=f.title;b.currentState=f;return true};b.Adapter.bind(h,"popstate",c.onPopState);b.pushState=function(a,d,e){a=b.createStateObject(a,d,e);c.storeState(a);l.pushState(a.data,a.title,a.url);b.Adapter.trigger(h,"popstate",{state:a.data});return true};b.replaceState=
function(a,d,e){a=b.createStateObject(a,d,e);c.storeState(a);l.replaceState(a.data,a.title,a.url);b.Adapter.trigger(h,"popstate",{state:a.data});return true}}b.back=function(){return l.go(-1)};b.forward=function(){return l.go(1)}};typeof b.Adapter!=="undefined"&&b.init()})(window);
