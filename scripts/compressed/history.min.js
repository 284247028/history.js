/*
 Public Domain
 @author Benjamin Lupton <contact@balupton.com>
 @author James Padolsey <https://gist.github.com/527683>
 Public Domain
 @author Benjamin Lupton <contact@balupton.com>
*/
(function(i,k){i.History=i.History||{};var m=i.console||k,f=i.document,c={},b=i.History,l=i.history;if(typeof b.emulated!=="undefined")throw Error("History.js has already been emulated...");b.init=function(){b.options={hashChangeCheckerDelay:100};b.debug=function(){b.debug.enable&&b.log.apply(b,arguments)};b.debug.enable=false;b.log=function(){var a=typeof m!=="undefined",d=f.getElementById("log"),e="\n"+arguments[0]+"\n",g;a&&m.log.apply(m,[arguments]);g=1;for(n=arguments.length;g<n;++g){var h=arguments[g];
if(typeof h==="object"&&typeof JSON!=="undefined")try{h=JSON.stringify(h)}catch(j){}e+="\n"+h+"\n"}if(d){d.value+=e+"\n-----\n";d.scrollTop=d.scrollHeight-d.clientHeight}else a||alert(e);return true};c.getInternetExplorerMajorVersion=function(){return c.getInternetExplorerMajorVersion.cached=typeof c.getInternetExplorerMajorVersion.cached!=="undefined"?c.getInternetExplorerMajorVersion.cached:function(){for(var a=3,d=f.createElement("div"),e=d.getElementsByTagName("i");d.innerHTML="<\!--[if gt IE "+
++a+"]><i></i><![endif]--\>",e[0];);return a>4?a:void 0}()};c.isInternetExplorer=function(){return c.isInternetExplorer.cached=typeof c.isInternetExplorer.cached!=="undefined"?c.isInternetExplorer.cached:c.getInternetExplorerMajorVersion()!==0};b.emulated={pushState:!Boolean(i.history&&i.history.pushState&&i.history.replaceState),hashChange:Boolean(!("onhashchange"in i||"onhashchange"in f)||c.isInternetExplorer()&&c.getInternetExplorerMajorVersion()<8)};c.isEmptyObject=function(a){for(var d in a)if(this.hasOwnProperty(d))return false;
return true};c.cloneObject=function(a){if(a){a=JSON.stringify(a);a=JSON.parse(a)}else a={};return a};b.setHash=function(a){var d=c.escapeHash(a);b.debug("History.setHash",this,arguments,"hash:",a,"adjustedHash:",d,"oldHash:",f.location.hash);f.location.hash=d;return a};b.getHash=function(){return c.unescapeHash(f.location.hash)};c.escapeHash=function(a){a=c.normalizeHash(a);if(/[^a-zA-Z0-9\/\-\_\%\.]/.test(a))a=escape(a);return a};c.unescapeHash=function(a){a=c.normalizeHash(a);if(/[\%]/.test(a))a=
unescape(a);return a};c.normalizeHash=function(a){return a.replace(/[^#]*#/,"").replace(/#.*/,"")};b.extractHashFromUrl=function(a){a=String(a).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");return a=c.unescapeHash(a)};b.isTraditionalAnchor=function(a){a=b.extractHashFromUrl(a);return typeof f.getElementById(a)!=="undefined"};b.contractUrl=function(a){a=b.expandUrl(a);var d=f.location.protocol+"//"+(f.location.hostname||f.location.host);if(f.location.port)d+=":"+f.location.port;d+="/";return a=a.replace(d,
"/")};b.expandUrl=function(a){a=a||"";if(!/[a-z]+\:\/\//.test(a))if(a.length===0||a.substring(0,1)==="?")a=f.location.href.replace(/[#\?].*/,"")+a;else{var d=f.getElementsByTagName("base"),e=null;e="";if(d.length===1){e=d[0];e=e.href;if(e[e.length-1]!=="/")e+="/";a=e+a.replace(/^\//,"")}else if(a.substring(0,1)==="."){d=f.location.href.replace(/[#\?].*/,"").replace(/[^\/]+$/,"");if(d[d.length-1]!=="/")d+="/";a=d+a}else{d=f.location.protocol+"//"+(f.location.hostname||f.location.host);if(f.location.port)d+=
":"+f.location.port;d+="/";a=d+a.replace(/^\//,"")}}return a};b.expandState=function(a){a=a||{};a={data:a.data||{},url:b.expandUrl(a.url||""),title:a.title||""};a.data.title=a.data.title||a.title;a.data.url=a.data.url||a.url;return a};b.createStateObject=function(a,d,e){a={data:a,title:d,url:e};return a=b.expandState(a)};b.expandHash=function(a){var d=null;try{d=JSON.parse(a)}catch(e){var g=/(.*)\/uid=([0-9]+)$/.exec(a);if(g=g?String(g[2]||""):"")d=c.getStateByUid(g)||null;if(!d&&/\//.test(a)){a=
b.expandUrl(a);d=b.createStateObject(null,null,a)}}return d=d?b.expandState(d):null};b.contractState=function(a){if(!a)return null;var d=null;if(a=c.cloneObject(a)){a.data=a.data||{};delete a.data.title;delete a.data.url;if(c.isEmptyObject(a)&&!a.title)d=b.contractUrl(a.url);else{d=JSON.stringify(a);var e;if(typeof c.hashesToUids[d]!=="undefined")e=c.hashesToUids[d];else for(;;){e=String(Math.floor(Math.random()*1E3));if(typeof c.uidsToStates[e]==="undefined")break}c.hashesToUids[d]=e;c.uidsToStates[e]=
a;d=b.contractUrl(a.url)+"/uid="+e}}return d};c.uidsToStates={};c.hashesToUids={};c.getStateByUid=function(a){return c.uidsToStates[String(a)]||k};c.statesByUrl={};c.duplicateStateUrls={};c.statesByHash={};c.savedStates=[];b.getState=function(){return c.getStateByIndex()};b.getStateHash=function(){return b.contractState(b.getState())};c.getStateByUrl=function(a){return c.statesByUrl[a]||k};c.getStateByHash=function(a){return c.statesByHash[a]||k};c.storeState=function(a){var d=b.contractState(a),
e=c.getStateByUrl(a.url);if(typeof e!=="undefined")if(b.contractState(e)!==d)c.duplicateStateUrls[a.url]=true;c.statesByUrl[a.url]=c.statesByHash[d]=a;return true};c.isLastState=function(a){a=b.contractState(a);var d=b.getStateHash();return c.savedStates.length&&a===d};c.saveState=function(a){if(c.isLastState(a))return false;c.savedStates.push(a);return true};c.getStateByIndex=function(a){var d=null;return d=typeof a==="undefined"?c.savedStates[c.savedStates.length-1]:a<0?c.savedStates[c.savedStates.length+
a]:c.savedStates[a]};c.stateUrlExists=function(a){return typeof c.statesByUrl[a]!=="undefined"};c.urlDuplicateExists=function(a){return typeof c.duplicateStateUrls[a]!=="undefined"};c.savedHashes=[];c.isLastHash=function(a){var d=c.getHashByIndex();return a===d};c.saveHash=function(a){if(c.isLastHash(a))return false;c.savedHashes.push(a);return true};c.getHashByIndex=function(a){var d=null;return d=typeof a==="undefined"?c.savedHashes[c.savedHashes.length-1]:a<0?c.savedHashes[c.savedHashes.length+
a]:c.savedHashes[a]};c.stateHashExists=function(a){return typeof c.statesByHash[a]!=="undefined"};c.discardedHashes={};c.discardedStates={};c.discardState=function(a,d,e){b.debug("History.discardState",this,arguments);var g=b.contractState(a);c.discardedStates[g]={discardedState:a,backState:e,forwardState:d};return true};c.discardHash=function(a,d,e){b.debug("History.discardState",this,arguments);c.discardedHashes[a]={discardedHash:a,backState:e,forwardState:d};return true};c.discardedState=function(a){a=
b.contractState(a);return c.discardedStates[a]||false};c.discardedHash=function(a){return c.discardedHashes[a]||false};c.recycleState=function(a){b.debug("History.recycleState",this,arguments);var d=b.contractState(a);c.discardedState(a)&&delete c.discardedStates[d];return true};b.emulated.hashChange&&function(){c.checkerFunction=null;if(c.isInternetExplorer()){var a=f.createElement("iframe");a.setAttribute("id","historyjs-iframe");a.style.display="none";f.body.appendChild(a);a.contentWindow.document.open();
a.contentWindow.document.close();var d=null,e=null,g=false;c.checkerFunction=function(){if(g){b.debug("hashchange.checker: checker is running");return false}g=true;var h=b.getHash(),j=c.unescapeHash(a.contentWindow.document.location.hash);if(h!==d){d=h;if(j!==h){b.debug("hashchange.checker: iframe hash change","documentHash (new):",h,"iframeHash (old):",j);e=h;a.contentWindow.document.open();a.contentWindow.document.close();a.contentWindow.document.location.hash=c.escapeHash(h)}b.Adapter.trigger(i,
"hashchange")}else if(j!==e){b.debug("hashchange.checker: iframe hash out of sync","iframeHash (new):",j,"documentHash (old):",h);e=j;b.setHash(j)}g=false;return true}}else{d=null;c.checkerFunction=function(){var h=b.getHash();if(h!==d){d=h;b.Adapter.trigger(i,"hashchange")}return true}}setInterval(c.checkerFunction,b.options.hashChangeCheckerDelay);return true}();if(b.emulated.pushState){c.onHashChange=function(a){b.debug("_History.onHashChange",this,arguments);currentHash=unescape(b.extractHashFromUrl(a&&
a.newURL||f.location.href));currentStateHashExits=currentStateHash=currentState=null;if(c.isLastHash(currentHash)){b.debug("_History.onHashChange: no change");return false}c.saveHash(currentHash);currentState=b.expandHash(currentHash);if(!currentState){b.debug("_History.onHashChange: traditional anchor");b.Adapter.trigger("anchorchange");return false}if(c.isLastState(currentState)){b.debug("_History.onHashChange: no change");return false}currentStateHash=b.contractState(currentState);b.debug("_History.onHashChange: ",
"currentStateHash",currentStateHash,"Hash -1",c.getHashByIndex(-1),"Hash -2",c.getHashByIndex(-2),"Hash -3",c.getHashByIndex(-3),"Hash -4",c.getHashByIndex(-4),"Hash -5",c.getHashByIndex(-5),"Hash -6",c.getHashByIndex(-6),"Hash -7",c.getHashByIndex(-7));var d=c.discardedState(currentState);if(d){b.debug("forwardState:",b.contractState(d.forwardState),"backState:",b.contractState(d.backState));if(c.getHashByIndex(-2)===b.contractState(d.forwardState)){b.debug("_History.onHashChange: go backwards");
b.back()}else{b.debug("_History.onHashChange: go forwards");b.forward()}return false}b.debug("_History.onHashChange: success hashchange");b.pushState(currentState.data,currentState.title,currentState.url);return true};b.Adapter.bind(i,"hashchange",c.onHashChange);b.pushState=function(a,d,e){b.debug("History.pushState",this,arguments);if(b.extractHashFromUrl(e))throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");var g=b.createStateObject(a,d,e),h=b.contractState(g);
b.getState();var j=b.getStateHash(),o=unescape(b.getHash());c.storeState(g);c.recycleState(g);if(g.title)f.title=g.title;b.debug("History.pushState: details","newStateHash:",h,"oldStateHash:",j,"html4Hash:",o);if(h===j){b.debug("History.pushState: no change",h);return false}if(h!==o){b.debug("History.pushState: update hash",h);b.setHash(h);return false}c.saveState(g);b.debug("History.pushState: trigger popstate");b.Adapter.trigger(i,"statechange");return true};b.replaceState=function(a,d,e){b.debug("History.replaceState",
this,arguments);if(b.extractHashFromUrl(e))throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");var g=b.createStateObject(a,d,e),h=b.getState(),j=c.getStateByIndex(-2);c.discardState(h,g,j);b.pushState(g.data,g.title,g.url);return true};if(!f.location.hash||f.location.hash==="#")b.Adapter.onDomLoad(function(){b.debug("hash1");var a=b.createStateObject({},"",f.location.href);b.pushState(a.data,a.title,a.url)});else if(!b.emulated.hashChange){b.debug("hash2");
b.Adapter.onDomLoad(function(){c.onHashChange()})}}else{c.onPopState=function(a){b.debug("_History.onPopState",this,arguments);var d=unescape(b.getHash());if(d){var e=b.expandHash(d);if(e){b.debug("_History.onPopState: state anchor",d,e);b.replaceState(e.data,e.tite,e.url)}else{b.debug("_History.onPopState: traditional anchor",d);b.Adapter.trigger(i,"anchorchange")}return false}d={};var g=e=null;d=null;a=a||{};if(typeof a.state==="undefined")if(typeof a.originalEvent!=="undefined"&&typeof a.originalEvent.state!==
"undefined")a.state=a.originalEvent.state;else if(typeof a.event!=="undefined"&&typeof a.event.state!=="undefined")a.state=a.event.state;if(a.state===null)d=a.state;else if(typeof a.state!=="undefined"){e=b.expandUrl(f.location.href);d=c.getStateByUrl(e);e=c.urlDuplicateExists(e);d=typeof d!=="undefined"&&!e?d.data:a.state}else{e=b.expandUrl(f.location.href);d=c.getStateByUrl(e);if(e==d.url)d=d.data;else throw Error("Unknown state");}d=typeof d!=="object"||d===null?{}:d;e=d.title||"";g=d.url||f.location.href;
d=b.createStateObject(d,e,g);if(c.isLastState(d)){b.debug("_History.onPopState: no change",d,c.savedStates);return false}b.debug("_History.onPopState","newState:",d,"oldState:",c.getStateByUrl(b.expandUrl(f.location.href)),"duplicateExists:",c.urlDuplicateExists(b.expandUrl(f.location.href)));c.storeState(d);c.saveState(d);if(d.title)f.title=d.title;b.Adapter.trigger(i,"statechange");return true};b.Adapter.bind(i,"popstate",c.onPopState);b.pushState=function(a,d,e){if(b.extractHashFromUrl(e))throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");
a=b.createStateObject(a,d,e);c.storeState(a);l.pushState(a.data,a.title,a.url);b.Adapter.trigger(i,"popstate");return true};b.replaceState=function(a,d,e){if(b.extractHashFromUrl(e))throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");a=b.createStateObject(a,d,e);c.storeState(a);l.replaceState(a.data,a.title,a.url);b.Adapter.trigger(i,"popstate");return true}}b.back=function(){b.debug("History.back: called");if(b.emulated.hashChange&&c.isInternetExplorer()){var a=
b.getHash();setTimeout(function(){if(b.getHash()===a){b.debug("History.back: trying again");return b.back()}return true},b.options.hashChangeCheckerDelay*2)}return l.go(-1)};b.forward=function(){b.debug("History.forward: called");if(b.emulated.hashChange&&c.isInternetExplorer()){var a=b.getHash();setTimeout(function(){if(b.getHash()===a){b.debug("History.forward: trying again");return b.forward()}return true},b.options.hashChangeCheckerDelay*2)}return l.go(1)};b.go=function(a){b.debug("History.go: called with index ["+
a+"]");if(a>0)for(var d=1;d<=a;++d){var e=b.options.hashChangeCheckerDelay*20*d;setTimeout(function(){b.debug("History.go: heading forward");b.forward()},e)}else if(a<0)for(d=-1;d>=a;--d){e=b.options.hashChangeCheckerDelay*20*d*-1;setTimeout(function(){b.debug("History.go: heading back");b.back()},e)}else throw Error("History.go: History.go requires a positive or negative integer passed.");return true};b.debug("History.emulated: hashchange["+b.emulated.hashChange+"] pushstate["+b.emulated.pushState+
"]")};typeof b.Adapter!=="undefined"&&b.init()})(window);
