/*
 Public Domain
 @author Benjamin Lupton <contact@balupton.com>
 @author James Padolsey <https://gist.github.com/527683>
 Public Domain
 @author Benjamin Lupton <contact@balupton.com>
*/
(function(i,l){i.History=i.History||{};var k=i.console||l,h=i.document,c={},a=i.History,m=i.history;if(typeof a.emulated!=="undefined")throw Error("History.js has already been emulated...");a.init=function(){a.options={hashChangeCheckerDelay:100,busyDelay:250};a.debug=function(){a.debug.enable&&a.log.apply(a,arguments)};a.debug.enable=false;a.log=function(){var b=typeof k!=="undefined",d=h.getElementById("log"),e="\n"+arguments[0]+"\n",f;if(b){f=Array.prototype.slice.call(arguments);e=f.shift();typeof k.debug!==
"undefined"?k.debug.apply(k,[e,f]):k.log.apply(k,[e,f])}f=1;for(n=arguments.length;f<n;++f){var g=arguments[f];if(typeof g==="object"&&typeof JSON!=="undefined")try{g=JSON.stringify(g)}catch(j){}e+="\n"+g+"\n"}if(d){d.value+=e+"\n-----\n";d.scrollTop=d.scrollHeight-d.clientHeight}else b||alert(e);return true};c.getInternetExplorerMajorVersion=function(){return c.getInternetExplorerMajorVersion.cached=typeof c.getInternetExplorerMajorVersion.cached!=="undefined"?c.getInternetExplorerMajorVersion.cached:
function(){for(var b=3,d=h.createElement("div"),e=d.getElementsByTagName("i");d.innerHTML="<\!--[if gt IE "+ ++b+"]><i></i><![endif]--\>",e[0];);return b>4?b:void 0}()};c.isInternetExplorer=function(){return c.isInternetExplorer.cached=typeof c.isInternetExplorer.cached!=="undefined"?c.isInternetExplorer.cached:c.getInternetExplorerMajorVersion()!==0};a.emulated={pushState:!Boolean(i.history&&i.history.pushState&&i.history.replaceState&&navigator.vendor!=="Apple Computer, Inc."),hashChange:Boolean(!("onhashchange"in
i||"onhashchange"in h)||c.isInternetExplorer()&&c.getInternetExplorerMajorVersion()<8)};c.isEmptyObject=function(b){for(var d in b)if(this.hasOwnProperty(d))return false;return true};c.cloneObject=function(b){if(b){b=JSON.stringify(b);b=JSON.parse(b)}else b={};return b};a.setHash=function(b,d){if(d!==false&&a.busy()){a.debug("History.setHash: we must wait",arguments);a.pushQueue({scope:a,callback:a.setHash,args:arguments,queue:d});return false}a.busy(true);var e=c.escapeHash(b);a.debug("History.setHash",
this,arguments,"hash:",b,"adjustedHash:",e,"oldHash:",h.location.hash);h.location.hash=e;return b};a.getHash=function(){return c.unescapeHash(h.location.hash)};c.escapeHash=function(b){b=c.normalizeHash(b);if(/[^a-zA-Z0-9\/\-\_\%\.]/.test(b))b=escape(b);return b};c.unescapeHash=function(b){b=c.normalizeHash(b);if(/[\%]/.test(b))b=unescape(b);return b};c.normalizeHash=function(b){return b.replace(/[^#]*#/,"").replace(/#.*/,"")};a.extractHashFromUrl=function(b){b=String(b).replace(/([^#]*)#?([^#]*)#?(.*)/,
"$2");return b=c.unescapeHash(b)};a.isTraditionalAnchor=function(b){b=a.extractHashFromUrl(b);return typeof h.getElementById(b)!=="undefined"};a.contractUrl=function(b){b=a.expandUrl(b);var d=h.location.protocol+"//"+(h.location.hostname||h.location.host);if(h.location.port)d+=":"+h.location.port;d+="/";return b=b.replace(d,"/")};a.expandUrl=function(b){b=b||"";if(!/[a-z]+\:\/\//.test(b))if(b.length===0||b.substring(0,1)==="?")b=h.location.href.replace(/[#\?].*/,"")+b;else{var d=h.getElementsByTagName("base"),
e=null;e="";if(d.length===1){e=d[0];e=e.href;if(e[e.length-1]!=="/")e+="/";b=e+b.replace(/^\//,"")}else if(b.substring(0,1)==="."){d=h.location.href.replace(/[#\?].*/,"").replace(/[^\/]+$/,"");if(d[d.length-1]!=="/")d+="/";b=d+b}else{d=h.location.protocol+"//"+(h.location.hostname||h.location.host);if(h.location.port)d+=":"+h.location.port;d+="/";b=d+b.replace(/^\//,"")}}return b};a.expandState=function(b){b=b||{};b={data:b.data||{},url:a.expandUrl(b.url||""),title:b.title||""};b.data.title=b.data.title||
b.title;b.data.url=b.data.url||b.url;return b};a.createStateObject=function(b,d,e){b={data:b,title:d,url:e};return b=a.expandState(b)};a.expandHash=function(b){var d=null;try{d=JSON.parse(b)}catch(e){var f=/(.*)\/uid=([0-9]+)$/.exec(b);if(f=f?String(f[2]||""):"")d=c.getStateByUid(f)||null;if(!d&&/\//.test(b)){b=a.expandUrl(b);d=a.createStateObject(null,null,b)}}return d=d?a.expandState(d):null};a.contractState=function(b){if(!b)return null;var d=null;if(b=c.cloneObject(b)){b.data=b.data||{};delete b.data.title;
delete b.data.url;if(c.isEmptyObject(b)&&!b.title)d=a.contractUrl(b.url);else{d=JSON.stringify(b);var e;if(typeof c.hashesToUids[d]!=="undefined")e=c.hashesToUids[d];else for(;;){e=String(Math.floor(Math.random()*1E3));if(typeof c.uidsToStates[e]==="undefined")break}c.hashesToUids[d]=e;c.uidsToStates[e]=b;d=a.contractUrl(b.url)+"/uid="+e}}return d};c.uidsToStates={};c.hashesToUids={};c.getStateByUid=function(b){return c.uidsToStates[String(b)]||l};c.statesByUrl={};c.duplicateStateUrls={};c.statesByHash=
{};c.savedStates=[];a.getState=function(){return c.getStateByIndex()};a.getStateHash=function(){return a.contractState(a.getState())};c.getStateByUrl=function(b){return c.statesByUrl[b]||l};c.getStateByHash=function(b){return c.statesByHash[b]||l};c.storeState=function(b){var d=a.contractState(b),e=c.getStateByUrl(b.url);if(typeof e!=="undefined")if(a.contractState(e)!==d)c.duplicateStateUrls[b.url]=true;c.statesByUrl[b.url]=c.statesByHash[d]=b;return true};c.isLastState=function(b){b=a.contractState(b);
var d=a.getStateHash();return c.savedStates.length&&b===d};c.saveState=function(b){if(c.isLastState(b))return false;c.savedStates.push(b);return true};c.getStateByIndex=function(b){var d=null;return d=typeof b==="undefined"?c.savedStates[c.savedStates.length-1]:b<0?c.savedStates[c.savedStates.length+b]:c.savedStates[b]};c.stateUrlExists=function(b){return typeof c.statesByUrl[b]!=="undefined"};c.urlDuplicateExists=function(b){return typeof c.duplicateStateUrls[b]!=="undefined"};c.savedHashes=[];c.isLastHash=
function(b){var d=c.getHashByIndex();return b===d};c.saveHash=function(b){if(c.isLastHash(b))return false;c.savedHashes.push(b);return true};c.getHashByIndex=function(b){var d=null;return d=typeof b==="undefined"?c.savedHashes[c.savedHashes.length-1]:b<0?c.savedHashes[c.savedHashes.length+b]:c.savedHashes[b]};c.stateHashExists=function(b){return typeof c.statesByHash[b]!=="undefined"};c.discardedHashes={};c.discardedStates={};c.discardState=function(b,d,e){a.debug("History.discardState",this,arguments);
var f=a.contractState(b);c.discardedStates[f]={discardedState:b,backState:e,forwardState:d};return true};c.discardHash=function(b,d,e){a.debug("History.discardState",this,arguments);c.discardedHashes[b]={discardedHash:b,backState:e,forwardState:d};return true};c.discardedState=function(b){b=a.contractState(b);return c.discardedStates[b]||false};c.discardedHash=function(b){return c.discardedHashes[b]||false};c.recycleState=function(b){a.debug("History.recycleState",this,arguments);var d=a.contractState(b);
c.discardedState(b)&&delete c.discardedStates[d];return true};a.queues=[];a.busy=function(b){a.debug("History.busy: called",arguments,a.busy.flag||l,a.queues);if(typeof b!=="undefined")a.busy.flag=b;else if(typeof a.busy.flag==="undefined")a.busy.flag=false;if(!a.busy.flag){clearTimeout(a.busy.timeout);var d=function(){if(!a.busy.flag)for(var e=a.queues.length-1;e>=0;--e){var f=a.queues[e];if(f.length!==0){f=f.shift();a.debug("History.busy: firing",f);f.callback.apply(f.scope||a,f.args||[]);a.busy.timeout=
setTimeout(d,a.options.busyDelay)}}};a.busy.timeout=setTimeout(d,a.options.busyDelay)}return a.busy.flag};a.pushQueue=function(b){a.debug("History.pushQueue: called",arguments);a.queues[b.queue||0]=a.queues[b.queue||0]||[];a.queues[b.queue||0].push(b);return true};a.back=function(b){a.debug("History.back: called",arguments);if(b!==false&&a.busy()){a.debug("History.back: we must wait",arguments);a.pushQueue({scope:a,callback:a.back,args:arguments,queue:b});return false}a.busy(true);if(a.emulated.hashChange&&
c.isInternetExplorer()){var d=a.getHash();setTimeout(function(){if(a.getHash()===d){a.debug("History.back: trying again");return a.back(false)}return true},a.options.hashChangeCheckerDelay*5)}m.go(-1)};a.forward=function(b){a.debug("History.forward: called",arguments);if(b!==false&&a.busy()){a.debug("History.forward: we must wait",arguments);a.pushQueue({scope:a,callback:a.forward,args:arguments,queue:b});return false}a.busy(true);if(a.emulated.hashChange&&c.isInternetExplorer()){var d=a.getHash();
setTimeout(function(){if(a.getHash()===d){a.debug("History.forward: trying again");return a.forward(false)}return true},a.options.hashChangeCheckerDelay*5)}m.go(1)};a.go=function(b,d){a.debug("History.go: called",arguments);if(b>0)for(var e=1;e<=b;++e)a.forward(d);else if(b<0)for(e=-1;e>=b;--e)a.back(d);else throw Error("History.go: History.go requires a positive or negative integer passed.");return true};if(a.emulated.hashChange)a.Adapter.onDomLoad(function(){c.checkerFunction=null;if(c.isInternetExplorer()){var b=
h.createElement("iframe");b.setAttribute("id","historyjs-iframe");b.style.display="none";h.body.appendChild(b);b.contentWindow.document.open();b.contentWindow.document.close();var d=null,e=null,f=false;c.checkerFunction=function(){if(f){a.debug("hashchange.checker: checker is running");return false}f=true;var g=a.getHash(),j=c.unescapeHash(b.contentWindow.document.location.hash);if(g!==d){d=g;if(j!==g){a.debug("hashchange.checker: iframe hash change","documentHash (new):",g,"iframeHash (old):",j);
e=g;b.contentWindow.document.open();b.contentWindow.document.close();b.contentWindow.document.location.hash=c.escapeHash(g)}a.Adapter.trigger(i,"hashchange")}else if(j!==e){a.debug("hashchange.checker: iframe hash out of sync","iframeHash (new):",j,"documentHash (old):",g);e=j;a.setHash(j,false)}f=false;return true}}else{d=null;c.checkerFunction=function(){var g=a.getHash();if(g!==d){d=g;a.Adapter.trigger(i,"hashchange")}return true}}setInterval(c.checkerFunction,a.options.hashChangeCheckerDelay);
return true});if(a.emulated.pushState){c.onHashChange=function(b){a.debug("_History.onHashChange",this,arguments);currentHash=unescape(a.extractHashFromUrl(b&&b.newURL||h.location.href));currentStateHashExits=currentStateHash=currentState=null;if(c.isLastHash(currentHash)){a.debug("_History.onHashChange: no change");a.busy(false);return false}c.saveHash(currentHash);currentState=a.expandHash(currentHash);if(!currentState){a.debug("_History.onHashChange: traditional anchor");a.Adapter.trigger(i,"anchorchange");
a.busy(false);return false}if(c.isLastState(currentState)){a.debug("_History.onHashChange: no change");a.busy(false);return false}currentStateHash=a.contractState(currentState);a.debug("_History.onHashChange: ","currentStateHash",currentStateHash,"Hash -1",c.getHashByIndex(-1),"Hash -2",c.getHashByIndex(-2),"Hash -3",c.getHashByIndex(-3),"Hash -4",c.getHashByIndex(-4),"Hash -5",c.getHashByIndex(-5),"Hash -6",c.getHashByIndex(-6),"Hash -7",c.getHashByIndex(-7));var d=c.discardedState(currentState);
if(d){a.debug("forwardState:",a.contractState(d.forwardState),"backState:",a.contractState(d.backState));if(c.getHashByIndex(-2)===a.contractState(d.forwardState)){a.debug("_History.onHashChange: go backwards");a.back(false)}else{a.debug("_History.onHashChange: go forwards");a.forward(false)}a.busy(false);return false}a.debug("_History.onHashChange: success hashchange");a.pushState(currentState.data,currentState.title,currentState.url,false);return true};a.Adapter.bind(i,"hashchange",c.onHashChange);
a.pushState=function(b,d,e,f){a.debug("History.pushState",this,arguments);if(a.extractHashFromUrl(e))throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(f!==false&&a.busy()){a.debug("History.pushState: we must wait",arguments);a.pushQueue({scope:a,callback:a.pushState,args:arguments,queue:f});return false}a.busy(true);var g=a.createStateObject(b,d,e),j=a.contractState(g);a.getState();var o=a.getStateHash(),p=unescape(a.getHash());c.storeState(g);c.recycleState(g);
if(h.title!==g.title){h.title=g.title;try{h.getElementsByTagName("title")[0].innerHTML=g.title}catch(q){}}a.debug("History.pushState: details","newStateHash:",j,"oldStateHash:",o,"html4Hash:",p);if(j===o){a.debug("History.pushState: no change",j);return false}if(j!==p){a.debug("History.pushState: update hash",j);a.setHash(j,false);return false}c.saveState(g);a.debug("History.pushState: trigger popstate");a.Adapter.trigger(i,"statechange");a.busy(false);return true};a.replaceState=function(b,d,e,f){a.debug("History.replaceState",
this,arguments);if(a.extractHashFromUrl(e))throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(f!==false&&a.busy()){a.debug("History.replaceState: we must wait",arguments);a.pushQueue({scope:a,callback:a.replaceState,args:arguments,queue:f});return false}a.busy(true);var g=a.createStateObject(b,d,e),j=a.getState(),o=c.getStateByIndex(-2);c.discardState(j,g,o);a.pushState(g.data,g.title,g.url,false);return true};if(!h.location.hash||h.location.hash==="#")a.Adapter.onDomLoad(function(){a.debug("Internet Explorer Initial State Change Fix");
var b=a.createStateObject({},"",h.location.href);a.pushState(b.data,b.title,b.url)});else if(!a.emulated.hashChange){a.debug("Firefox Initial State Change Fix");a.Adapter.onDomLoad(function(){c.onHashChange()})}}else{c.onPopState=function(b){a.debug("_History.onPopState",this,arguments);var d=unescape(a.getHash());if(d){var e=a.expandHash(d);if(e){a.debug("_History.onPopState: state anchor",d,e);a.replaceState(e.data,e.tite,e.url,false)}else{a.debug("_History.onPopState: traditional anchor",d);a.Adapter.trigger(i,
"anchorchange");a.busy(false)}return false}d={};var f=e=null;d=null;b=b||{};if(typeof b.state==="undefined")if(typeof b.originalEvent!=="undefined"&&typeof b.originalEvent.state!=="undefined")b.state=b.originalEvent.state;else if(typeof b.event!=="undefined"&&typeof b.event.state!=="undefined")b.state=b.event.state;if(b.state===null)d=b.state;else if(typeof b.state!=="undefined"){e=a.expandUrl(h.location.href);d=c.getStateByUrl(e);e=c.urlDuplicateExists(e);d=typeof d!=="undefined"&&!e?d.data:b.state}else{e=
a.expandUrl(h.location.href);if((d=c.getStateByUrl(e))&&e==d.url)d=d.data;else throw Error("Unknown state");}d=typeof d!=="object"||d===null?{}:d;e=d.title||"";f=d.url||h.location.href;d=a.createStateObject(d,e,f);if(c.isLastState(d)){a.debug("_History.onPopState: no change",d,c.savedStates);a.busy(false);return false}a.debug("_History.onPopState","newState:",d,"oldState:",c.getStateByUrl(a.expandUrl(h.location.href)),"duplicateExists:",c.urlDuplicateExists(a.expandUrl(h.location.href)));c.storeState(d);
c.saveState(d);if(d.title)h.title=d.title;a.Adapter.trigger(i,"statechange");a.busy(false);return true};a.Adapter.bind(i,"popstate",c.onPopState);a.pushState=function(b,d,e,f){if(a.extractHashFromUrl(e))throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(f!==false&&a.busy()){a.debug("History.pushState: we must wait",arguments);a.pushQueue({scope:a,callback:a.pushState,args:arguments,queue:f});return false}a.busy(true);var g=a.createStateObject(b,d,e);
c.storeState(g);m.pushState(g.data,g.title,g.url);a.Adapter.trigger(i,"popstate");return true};a.replaceState=function(b,d,e,f){if(a.extractHashFromUrl(e))throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(f!==false&&a.busy()){a.debug("History.replaceState: we must wait",arguments);a.pushQueue({scope:a,callback:a.replaceState,args:arguments,queue:f});return false}a.busy(true);var g=a.createStateObject(b,d,e);c.storeState(g);m.replaceState(g.data,g.title,
g.url);a.Adapter.trigger(i,"popstate");return true}}};typeof a.Adapter!=="undefined"&&a.init()})(window);
